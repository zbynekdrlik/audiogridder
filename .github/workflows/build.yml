name: Build AudioGridder

on:
  push:
    branches: [ main, master, develop, fix/* ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_TYPE: RelWithDebInfo

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Clone dependencies
      run: |
        git clone https://github.com/apohl79/audiogridder-deps.git

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Configure CMake
      run: |
        python build.py conf --disable-signing -t ${{ env.BUILD_TYPE }} --deps-root audiogridder-deps

    - name: Build
      run: |
        python build.py build

    - name: List build outputs
      run: |
        Get-ChildItem -Recurse build-windows-x86_64/lib -ErrorAction SilentlyContinue | Select-Object FullName
        Get-ChildItem -Recurse build-windows-x86_64/bin -ErrorAction SilentlyContinue | Select-Object FullName

    - name: Package plugins (ZIP)
      run: |
        mkdir -p artifacts
        # Copy VST3 plugins
        if (Test-Path "build-windows-x86_64/lib/VST3") {
          Copy-Item -Recurse "build-windows-x86_64/lib/VST3/*" "artifacts/" -ErrorAction SilentlyContinue
        }
        # Copy executables
        if (Test-Path "build-windows-x86_64/bin") {
          Copy-Item "build-windows-x86_64/bin/*.exe" "artifacts/" -ErrorAction SilentlyContinue
        }
        Get-ChildItem -Recurse artifacts/

    - name: Create Inno Setup installer
      run: |
        # Get version
        $version = Get-Content "package/VERSION.num" -Raw
        $version = $version.Trim()

        # Configure .iss files from templates
        $pluginIss = Get-Content "package/AudioGridderPlugin.iss.in" -Raw
        $pluginIss = $pluginIss -replace "#STR_VER#", $version
        $pluginIss | Out-File -FilePath "package/AudioGridderPlugin.iss" -Encoding ASCII

        $serverIss = Get-Content "package/AudioGridderServer.iss.in" -Raw
        $serverIss = $serverIss -replace "#STR_VER#", $version
        $serverIss | Out-File -FilePath "package/AudioGridderServer.iss" -Encoding ASCII

        # Create build output directory
        mkdir -p package/build -ErrorAction SilentlyContinue

        # Run Inno Setup
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /Opackage/build "package/AudioGridderPlugin.iss"
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /Opackage/build "package/AudioGridderServer.iss"
      continue-on-error: true

    - name: Upload Windows VST3 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: audiogridder-windows-x86_64
        path: artifacts/
        retention-days: 30

    - name: Upload Windows Installer (Plugin)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: audiogridder-plugin-installer-windows
        path: package/build/AudioGridderPlugin_*.exe
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload Windows Installer (Server)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: audiogridder-server-installer-windows
        path: package/build/AudioGridderServer_*.exe
        retention-days: 30
        if-no-files-found: ignore

  build-linux:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Clone dependencies
      run: |
        git clone https://github.com/apohl79/audiogridder-deps.git

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libfreetype6-dev \
          libasound2-dev \
          libwebkit2gtk-4.0-dev \
          libcurl4-openssl-dev \
          libgtk-3-dev \
          libgl1-mesa-dev \
          libxcb-xfixes0-dev \
          libxcb-shape0-dev \
          pkg-config \
          clang \
          python3

    - name: Configure CMake
      run: |
        python3 build.py conf \
          --disable-signing \
          -t ${{ env.BUILD_TYPE }} \
          --deps-root audiogridder-deps

    - name: Build
      run: |
        python3 build.py build

    - name: Package plugins
      run: |
        mkdir -p artifacts/VST3
        cp build-linux-x86_64/debug/VST3/*.so artifacts/VST3/ 2>/dev/null || \
        cp build-linux-x86_64/lib/*.so artifacts/VST3/ 2>/dev/null || true
        cp build-linux-x86_64/bin/AudioGridderServer artifacts/ 2>/dev/null || true
        cp build-linux-x86_64/bin/AudioGridderPluginTray artifacts/ 2>/dev/null || true
        ls -laR artifacts/

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: audiogridder-linux-x86_64
        path: artifacts/
        retention-days: 30
