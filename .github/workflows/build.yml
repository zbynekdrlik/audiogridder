name: Build AudioGridder

on:
  push:
    branches: [ main, master, develop, fix/* ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_TYPE: RelWithDebInfo

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Clone dependencies
      run: |
        git clone https://github.com/apohl79/audiogridder-deps.git

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libfreetype6-dev \
          libasound2-dev \
          libwebkit2gtk-4.0-dev \
          libcurl4-openssl-dev \
          libgtk-3-dev \
          libgl1-mesa-dev \
          libxcb-xfixes0-dev \
          libxcb-shape0-dev \
          pkg-config \
          clang \
          python3

    - name: Configure CMake
      run: |
        python3 build.py conf \
          --disable-signing \
          --build-type ${{ env.BUILD_TYPE }} \
          --deps-root audiogridder-deps

    - name: Build
      run: |
        python3 build.py build

    - name: Package plugins
      run: |
        mkdir -p artifacts/VST3
        cp build-linux-x86_64/debug/VST3/*.so artifacts/VST3/ 2>/dev/null || \
        cp build-linux-x86_64/lib/*.so artifacts/VST3/ 2>/dev/null || true
        cp build-linux-x86_64/bin/AudioGridderServer artifacts/ 2>/dev/null || true
        cp build-linux-x86_64/bin/AudioGridderPluginTray artifacts/ 2>/dev/null || true
        ls -laR artifacts/

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: audiogridder-linux-x86_64
        path: artifacts/
        retention-days: 30

  build-linux-installer:
    runs-on: ubuntu-22.04
    needs: build-linux

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: audiogridder-linux-x86_64
        path: artifacts/

    - name: Create installer package
      run: |
        mkdir -p installer
        cp -r artifacts/* installer/
        cat > installer/install.sh << 'INSTALL_EOF'
        #!/bin/bash
        set -e
        VST3_DIR="$HOME/.vst3"
        BIN_DIR="$HOME/.local/bin"
        mkdir -p "$VST3_DIR" "$BIN_DIR"
        echo "=== AudioGridder Linux Installer ==="
        if [ -d "VST3" ]; then
          echo "Installing VST3 plugins to $VST3_DIR..."
          for so in VST3/*.so; do
            [ -f "$so" ] && cp "$so" "$VST3_DIR/"
          done
        fi
        [ -f "AudioGridderServer" ] && cp AudioGridderServer "$BIN_DIR/" && chmod +x "$BIN_DIR/AudioGridderServer"
        [ -f "AudioGridderPluginTray" ] && cp AudioGridderPluginTray "$BIN_DIR/" && chmod +x "$BIN_DIR/AudioGridderPluginTray"
        echo "Installation complete!"
        echo "VST3 plugins: $VST3_DIR"
        echo "Executables: $BIN_DIR"
        INSTALL_EOF
        chmod +x installer/install.sh
        tar -czvf audiogridder-linux-x86_64.tar.gz -C installer .

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: audiogridder-installer-linux-x86_64
        path: audiogridder-linux-x86_64.tar.gz
        retention-days: 30
